<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Ocean">
    <meta name="description" content="要善良,要勇敢,要像星星一样努力发光。若是你心怀旧梦，就别再无疾而终。加油，为实现梦想努力。梦想再遥远，也要笑着走去，毕竟沿途有很多美景等着去欣赏。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Ocean</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body{
            background-image: url(/medias/ocean.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Ocean</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Ocean</div>
        <div class="logo-desc">
            
            要善良,要勇敢,要像星星一样努力发光。若是你心怀旧梦，就别再无疾而终。加油，为实现梦想努力。梦想再遥远，也要笑着走去，毕竟沿途有很多美景等着去欣赏。
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/oceanechy" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/oceanechy" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title"></h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-12-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    52 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="主要记录SSC中的理论与代码实现"><a href="#主要记录SSC中的理论与代码实现" class="headerlink" title="主要记录SSC中的理论与代码实现"></a>主要记录SSC中的理论与代码实现</h1><p>主要从开篇之作SSCNet（2017）开始讲起，然后按激光雷达点云输入（LMSCNet，2020；S3CNet，2021a；JS3C-Net，2021）,单双目以及两者融合的顺序</p>
<h2 id="首先是开篇之作SSCNet"><a href="#首先是开篇之作SSCNet" class="headerlink" title="首先是开篇之作SSCNet"></a>首先是开篇之作SSCNet</h2><p>官方代码实在caffe框架上搭建的，第一个将语义分割和场景完成与 3D CNN 端到端结合的工作，从单视图深度地图观察生成一个完整的三维体素表示的体积占用和语义标签的场景，利用这两个任务的耦合特性，引入了语义场景完成网络(SSCNet)</p>
<p>代码链接： <a target="_blank" rel="noopener" href="https://github.com/shurans/sscnet">SSCNet: Semantic Scene Completion from a Single Depth Image</a>, 2017</p>
<p><img src="/pic/SSCNet.png"></p>
<p>代码：<br>使用Caffe框架的网络定义txt文件,主要包括下面几个部分:</p>
<ul>
<li>数据层 (layer { name: “data” … })： 这是数据输入层，它从SUNCG数据集中加载数据。数据集包括深度信息（可能是三维数据）以及标签信息（seg_label）。还包括一些参数，如体素大小、裁剪大小、类别映射等。</li>
<li>卷积层 (layer { name: “conv1_1” … })： 这是一个卷积层，用于提取特征。它定义了卷积核的数量、大小、填充等参数。</li>
<li>ReLU 层 (layer { name: “relu1_1” … })： 这是激活函数层，通常用于引入非线性性。ReLU（Rectified Linear Unit）是一种常见的激活函数。</li>
<li>池化层 (layer { name: “pool2” … })： 这是一个池化层，用于降低特征图的分辨率，通常用于减少计算复杂度。</li>
<li>Eltwise 层 (layer { name: “res3_2” … })： 这是一个元素级操作层，通常用于残差网络（ResNet）中，用于连接不同层的输出。</li>
<li>全连接层 (layer { name: “fc12” … })： 这是一个全连接层，用于将卷积层的输出映射到最终的分类标签或预测。</li>
<li>SoftmaxWithLoss 层 (layer { name: “loss” … })： 这是损失层，通常与Softmax函数一起使用，用于计算损失函数，用于模型训练。</li>
</ul>
<h3 id="数据层配置"><a href="#数据层配置" class="headerlink" title="数据层配置"></a>数据层配置</h3><p>数据层在深度学习模型中是一个关键组成部分，用于加载和处理输入数据。在你提供的代码中，数据层的定义如下：</p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf">layer <span class="token punctuation">&#123;</span>
  name<span class="token punctuation">:</span> <span class="token string">"data"</span>
  type<span class="token punctuation">:</span> <span class="token string">"SuncgData"</span>
  top<span class="token punctuation">:</span> <span class="token string">"data"</span>
  top<span class="token punctuation">:</span> <span class="token string">"seg_label"</span>
  top<span class="token punctuation">:</span> <span class="token string">"seg_weight"</span>
  suncg_data_param <span class="token punctuation">&#123;</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_1_500"</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_501_1000"</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_1001_2000"</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_1001_3000"</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_3001_5000"</span>
    file_data<span class="token punctuation">:</span> <span class="token string">"../../../../data/depthbin/SUNCGtrain_5001_7000"</span>
    file_list<span class="token punctuation">:</span> <span class="token string">""</span>
    vox_unit<span class="token punctuation">:</span> <span class="token number">0.02</span>
    vox_margin<span class="token punctuation">:</span> <span class="token number">0.24</span>
    vox_size<span class="token punctuation">:</span> <span class="token number">240</span>
    vox_size<span class="token punctuation">:</span> <span class="token number">144</span>
    vox_size<span class="token punctuation">:</span> <span class="token number">240</span>
    crop_size<span class="token punctuation">:</span> <span class="token number">240</span>
    crop_size<span class="token punctuation">:</span> <span class="token number">144</span>
    crop_size<span class="token punctuation">:</span> <span class="token number">240</span>
    label_size<span class="token punctuation">:</span> <span class="token number">60</span>
    label_size<span class="token punctuation">:</span> <span class="token number">36</span>
    label_size<span class="token punctuation">:</span> <span class="token number">60</span>
    seg_classes<span class="token punctuation">:</span> <span class="token number">11</span>
    shuffle<span class="token punctuation">:</span> <span class="token boolean">true</span>
    occ_empty_only<span class="token punctuation">:</span> <span class="token boolean">true</span>
    neg_obj_sample_ratio<span class="token punctuation">:</span> <span class="token number">2</span>
    seg_class_map<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    seg_class_weight<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    occ_class_weight<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    with_projection_tsdf<span class="token punctuation">:</span> <span class="token boolean">false</span>
    batch_size<span class="token punctuation">:</span> <span class="token number">1</span>
    tsdf_type<span class="token punctuation">:</span> <span class="token number">1</span>
    data_type<span class="token punctuation">:</span> TSDF
    surf_only<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要参数如下</p>
<ul>
<li><p><strong>name: “data”：</strong> 数据层的名称，用于在模型中引用该层。</p>
</li>
<li><p><strong>type: “SuncgData”：</strong> 数据层的类型，指定了如何处理数据。</p>
</li>
<li><p><strong>top: “data”, top: “seg_label”, top: “seg_weight”：</strong> 数据层的输出，模型中其他层可以引用这些输出。</p>
</li>
<li><p><strong>suncg_data_param：</strong> 数据层的参数配置块。</p>
</li>
<li><p><strong>file_data：</strong> 数据文件的路径，用于加载数据。这里看起来是从SUNCG数据集中加载深度信息。</p>
</li>
<li><p><strong>vox_unit, vox_margin, vox_size：</strong> 与体素（Voxel）的设置相关。<code>vox_unit</code>是体素的大小，<code>vox_margin</code>是体素的边缘大小，<code>vox_size</code>是体素在每个维度的数量。这些参数定义了体素网格的离散化空间。</p>
</li>
<li><p><strong>crop_size 和 label_size：</strong> 数据的裁剪大小和标签大小。<code>crop_size</code>表示输入数据的裁剪尺寸，<code>label_size</code>表示标签的大小。</p>
</li>
<li><p><strong>seg_classes：</strong> 指定了分类任务中的类别数量。</p>
</li>
<li><p><strong>shuffle：</strong> 一个布尔值，表示是否在加载数据时进行洗牌（打乱数据顺序）。</p>
</li>
<li><p><strong>occ_empty_only：</strong> 一个布尔值，可能表示只关注占用（occupied）和空闲（empty）之间的区别。</p>
</li>
<li><p><strong>neg_obj_sample_ratio：</strong> 负对象采样比例。</p>
</li>
<li><p><strong>seg_class_map, seg_class_weight, occ_class_weight：</strong> 用于定义不同类别的映射和权重。<code>seg_class_map</code>用于将一些类别映射到其他类别，<code>seg_class_weight</code>和<code>occ_class_weight</code>用于类别的权重设置。</p>
</li>
<li><p><strong>with_projection_tsdf 和 surf_only：</strong> 控制是否使用投影TSDF和是否仅考虑表面信息。投影TSDF通常用于三维重建，而<code>surf_only</code>可能用于指示仅关注表面的信息。</p>
</li>
<li><p><strong>batch_size：</strong> 训练时的批处理大小，影响每次模型权重更新时使用的样本数量。</p>
</li>
<li><p><strong>tsdf_type 和 data_type：</strong> 与数据类型相关的参数，例如TSDF数据类型。</p>
</li>
<li><p><strong>surf_only：</strong> 一个布尔值，可能表示是否仅考虑表面数据。</p>
</li>
</ul>
<p>这些参数共同定义了数据层的行为，确保数据被正确加载和预处理，以供深度学习模型使用。</p>
<h2 id="LMSCNet"><a href="#LMSCNet" class="headerlink" title="LMSCNet"></a>LMSCNet</h2><p>代码链接： <a target="_blank" rel="noopener" href="https://github.com/astra-vision/LMSCNet">LMSCNet: Lightweight Multiscale 3D Semantic Completion</a>, 3DV 2020</p>
<p>一种从体素化稀疏三维激光雷达扫描中完成多尺度三维语义场景的新方法,使用具有全面多尺度跳跃连接的2D UNet主干来增强特征流，以及3D分割头</p>
<p><img src="/pic/LMSCNet.png"></p>
<p>首先看配置文件<a target="_blank" rel="noopener" href="https://github.com/astra-vision/LMSCNet/blob/main/SSC_configs/examples/LMSCNet.yaml">LMSCNet.yaml</a>这段代码是一个用于训练深度学习模型的Python脚本，基于LMSCNet网络。以下是关于训练设置以及代码的关键部分的解释：</p>
<h3 id="训练设置"><a href="#训练设置" class="headerlink" title="训练设置"></a>训练设置</h3><ul>
<li><p><strong>数据加载器设置：</strong></p>
<ul>
<li><code>NUM_WORKERS: 4</code>：用于数据加载的工作线程数。</li>
</ul>
</li>
<li><p><strong>数据集设置：</strong></p>
<ul>
<li>数据增强：<ul>
<li><code>FLIPS: true</code>：表示是否进行数据增强，包括翻转等。</li>
</ul>
</li>
<li>模态设置：<ul>
<li><code>3D_LABEL: true</code>：表示是否使用3D标签数据。</li>
<li><code>3D_OCCLUDED: true</code>：表示是否使用3D遮挡数据。</li>
<li><code>3D_OCCUPANCY: true</code>：表示是否使用3D占用数据。</li>
</ul>
</li>
<li><code>ROOT_DIR: /datasets_local/datasets_lroldaoj/semantic_kitti_v1.0/</code>：数据集的根目录。</li>
<li><code>TYPE: SemanticKITTI</code>：数据集的类型，这里是SemanticKITTI。</li>
</ul>
</li>
<li><p><strong>模型设置：</strong></p>
<ul>
<li><code>TYPE: LMSCNet</code>：使用的模型类型为LMSCNet。</li>
</ul>
</li>
<li><p><strong>优化器设置：</strong></p>
<ul>
<li><code>BASE_LR: 0.001</code>：学习率的初始值。</li>
<li><code>BETA1: 0.9</code>：Adam优化器的beta1参数。</li>
<li><code>BETA2: 0.999</code>：Adam优化器的beta2参数。</li>
<li><code>MOMENTUM: NA</code>：动量参数（未设置）。</li>
<li><code>TYPE: Adam</code>：优化器的类型。</li>
<li><code>WEIGHT_DECAY: NA</code>：权重衰减参数（未设置）。</li>
</ul>
</li>
<li><p><strong>输出设置：</strong></p>
<ul>
<li><code>OUT_ROOT: ../SSC_out/</code>：输出结果的根目录。</li>
</ul>
</li>
<li><p><strong>调度器设置：</strong></p>
<ul>
<li><code>FREQUENCY: epoch</code>：学习率调度的频率为每个epoch。</li>
<li><code>LR_POWER: 0.98</code>：学习率调度的幂次方。</li>
<li><code>TYPE: power_iteration</code>：学习率调度类型。</li>
</ul>
</li>
<li><p><strong>状态设置：</strong></p>
<ul>
<li><code>RESUME: false</code>：是否从之前的检查点中恢复训练（未设置为恢复）。</li>
</ul>
</li>
<li><p><strong>训练设置：</strong></p>
<ul>
<li><code>BATCH_SIZE: 4</code>：每个批次的样本数量。</li>
<li><code>CHECKPOINT_PERIOD: 15</code>：保存检查点的周期。</li>
<li><code>EPOCHS: 80</code>：总共训练的轮数。</li>
<li><code>SUMMARY_PERIOD: 50</code>：汇总损失的周期。</li>
</ul>
</li>
<li><p><strong>验证设置：</strong></p>
<ul>
<li><code>BATCH_SIZE: 8</code>：验证时的批次大小。</li>
<li><code>SUMMARY_PERIOD: 20</code>：验证损失的周期。</li>
</ul>
</li>
</ul>
<h3 id="LMSCNet网络代码解释"><a href="#LMSCNet网络代码解释" class="headerlink" title="LMSCNet网络代码解释"></a>LMSCNet网络代码解释</h3><p><a target="_blank" rel="noopener" href="https://github.com/astra-vision/LMSCNet/blob/main/LMSCNet/models/LMSCNet.py">LMSCNet.py</a></p>
<p>当分析这个神经网络模型时，我们可以将其分解为以下几个关键组件和部分。以下是对这些组件和部分的更详细解释：</p>
<h4 id="SegmentationHead（分割头部）"><a href="#SegmentationHead（分割头部）" class="headerlink" title="SegmentationHead（分割头部）"></a>SegmentationHead（分割头部）</h4><p><code>SegmentationHead</code> 类用于处理单一尺度的语义分割任务。它包括以下组件：</p>
<ul>
<li><p><strong>First Convolution (第一个卷积层)</strong>: <code>conv0</code> 定义了一个3D卷积层，用于将输入的特征从一个尺度（inplanes）转换到 <code>planes</code>。这是模型的初始特征处理步骤。</p>
</li>
<li><p><strong>ASPP Block (空间金字塔池化块)</strong>: <code>ASPP</code> 是”空间金字塔池化块”的缩写，它由多个卷积层和扩张卷积层（dilated convolution）组成。这些层用于捕捉不同感受野（receptive field）下的特征。这有助于模型更好地理解图像中的上下文信息。<code>conv1</code> 包括多个扩张卷积层，<code>bn1</code> 是相应的批归一化层，然后再通过 <code>conv2</code> 进行进一步处理。这些层通过 ReLU 激活函数进行激活。</p>
</li>
<li><p><strong>Convolution for Output (用于输出的卷积)</strong>: <code>conv_classes</code> 是用于生成最终语义分割预测的卷积层，其输出通道数等于目标类别数 <code>nbr_classes</code>。</p>
</li>
</ul>
<h4 id="LMSCNet（语义分割网络）"><a href="#LMSCNet（语义分割网络）" class="headerlink" title="LMSCNet（语义分割网络）"></a>LMSCNet（语义分割网络）</h4><p><code>LMSCNet</code> 类定义了整个语义分割网络，它的结构包括：</p>
<ul>
<li><p><strong>Encoder Blocks (编码块)</strong>: 这些块包括卷积层和激活函数，它们用于从输入数据提取特征。编码块分层堆叠，逐渐降低分辨率。其中 <code>Encoder_block1</code> 处理输入数据，然后 <code>Encoder_block2</code>、<code>Encoder_block3</code> 和 <code>Encoder_block4</code> 分别进行更多的特征提取。</p>
</li>
<li><p><strong>Output Scales (输出尺度)</strong>: 模型产生多个尺度的语义分割输出，包括1:8、1:4、1:2和1:1。每个输出尺度都有相应的卷积层和<code>SegmentationHead</code>。这些层用于生成不同分辨率下的语义分割预测。</p>
</li>
<li><p><strong>反卷积层 (Deconvolution Layers)</strong>: 这些层包括<code>deconv_1_8__1_2</code>、<code>deconv_1_8__1_1</code>、<code>deconv1_4</code>、<code>deconv1_2</code> 和 <code>deconv1_1</code>，用于上采样，将较低分辨率的输出转换为高分辨率。这些层用于与高分辨率的编码块特征进行连接。</p>
</li>
<li><p><strong>权重初始化和损失计算</strong>: 类中还包括了初始化权重的函数 <code>weights_initializer</code>，以及用于计算损失的函数 <code>compute_loss</code>。损失计算使用交叉熵损失，针对每个尺度的输出都会计算相应的损失。</p>
</li>
<li><p><strong>类别权重 (Class Weights)</strong>: 模型使用 <code>get_class_weights</code> 函数计算类别权重，以便处理不平衡的类别分布。</p>
</li>
<li><p><strong>其他辅助函数</strong>: 类还包括其他用于获取目标数据、设置训练尺度等的辅助函数。</p>
</li>
</ul>
<p>这个模型的核心思想是从低分辨率到高分辨率逐步提取特征，并生成多尺度的语义分割预测。模型的损失函数考虑了所有尺度的预测，以便综合多尺度信息来进行训练。这有助于提高语义分割任务的性能，特别是在处理不同尺度的对象时。模型的训练和验证过程通常需要提供训练数据、优化器和学习率调度器等组件。</p>
<h2 id="JS3CNet"><a href="#JS3CNet" class="headerlink" title="JS3CNet"></a>JS3CNet</h2><p>一种增强的联合单扫LiDAR点云语义分割方法，该方法利用学习的形状先验形式场景完成网络，即JS3C-Net</p>
<p>代码链接： <a target="_blank" rel="noopener" href="https://github.com/yanx27/JS3C-Net">JS3CNet: Sparse Single Sweep LiDAR Point Cloud Segmentation via Learning Contextual Shape Priors from Scene Completion</a>, AAAI 2021</p>
<p><img src="/pic/JS3CNet.png" alt="在给定稀疏不完全单扫描点云的情况下，首先使用稀疏卷积U-Net对Fenc进行点特征编码。基于初始编码，MLP1用于生成形状嵌入（SE）FSE，该FSE与通过MLP2传递的初始编码一起流入MLP3，以生成用于点云语义分割的Fout。然后，来自SE的不完整细粒度点特征和来自语义场景完成（SSC）模块的完整体素特征流入点-体素交互（PVI）模块，以实现细化特征，最终在监督下输出完成体素。请注意，SSC和PVI模块可以在推理过程中丢弃。"></p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p><a target="_blank" rel="noopener" href="https://github.com/yanx27/JS3C-Net/blob/main/opt/JS3C_default_kitti.yaml">JS3C_default_kitti.yaml</a>这是一个JS3CNet网络的配置文件。配置文件用于定义训练和测试JS3CNet网络时的各种参数和设置。以下是关于配置文件的详细解释：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">GENERAL</span><span class="token punctuation">:</span>
  <span class="token key atrule">task</span><span class="token punctuation">:</span> train
  <span class="token key atrule">manual_seed</span><span class="token punctuation">:</span> <span class="token number">123</span>
  <span class="token key atrule">dataset_dir</span><span class="token punctuation">:</span> /home/yxu/data/semantic_kitti/dataset/
  <span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>task</code>: 定义任务类型，这里设置为”train”表示进行训练。</li>
<li><code>manual_seed</code>: 随机数种子，用于确保实验的可复现性。</li>
<li><code>dataset_dir</code>: 数据集的目录路径。</li>
<li><code>debug</code>: 是否启用调试模式，设置为”False”表示不启用。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATA</span><span class="token punctuation">:</span>
  <span class="token key atrule">dataset</span><span class="token punctuation">:</span> SemanticKITTI
  <span class="token key atrule">classes_seg</span><span class="token punctuation">:</span> <span class="token number">19</span>
  <span class="token key atrule">classes_completion</span><span class="token punctuation">:</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>dataset</code>: 数据集的名称，这里使用SemanticKITTI数据集。</li>
<li><code>classes_seg</code>: 语义分割任务的类别数，这里设置为19。</li>
<li><code>classes_completion</code>: 完备性任务的类别数，这里设置为20。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">Segmentation</span><span class="token punctuation">:</span>
  <span class="token key atrule">model_name</span><span class="token punctuation">:</span> SubSparseConv
  <span class="token key atrule">m</span><span class="token punctuation">:</span> <span class="token number">16</span>
  <span class="token key atrule">block_residual</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">block_reps</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">seg_groups</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">use_coords</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">feature_dims</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">]</span>
  <span class="token key atrule">input_channel</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">scale</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">full_scale</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span>
  <span class="token key atrule">max_npoint</span><span class="token punctuation">:</span> <span class="token number">250000</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>Segmentation</code>部分包含了与语义分割任务相关的参数设置。</li>
<li><code>model_name</code>: 语义分割模型的名称，这里使用SubSparseConv。</li>
<li><code>m</code>: SubSparseConv模型的参数，这里设置为16。</li>
<li><code>block_residual</code>: 是否使用块残差，设置为”False”表示不使用。</li>
<li><code>block_reps</code>: 块的重复次数，这里设置为1。</li>
<li><code>seg_groups</code>: 分割组的数量，这里设置为1。</li>
<li><code>use_coords</code>: 是否使用坐标信息，设置为”False”表示不使用。</li>
<li><code>feature_dims</code>: 特征维度的设置。</li>
<li><code>input_channel</code>: 输入通道的数量，这里设置为3。</li>
<li><code>scale</code>: 数据集的尺度。</li>
<li><code>full_scale</code>: 数据集的完全尺度范围。</li>
<li><code>max_npoint</code>: 最大点数，这里设置为250,000。</li>
<li><code>mode</code>: 模式设置，这里设置为4。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">Completion</span><span class="token punctuation">:</span>
  <span class="token key atrule">model_name</span><span class="token punctuation">:</span> SSCNet
  <span class="token key atrule">m</span><span class="token punctuation">:</span> <span class="token number">32</span>
  <span class="token key atrule">feeding</span><span class="token punctuation">:</span> both
  <span class="token key atrule">no_fuse_feat</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">block_residual</span><span class="token punctuation">:</span> <span class="token boolean important">True</span>
  <span class="token key atrule">block_reps</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">use_coords</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">full_scale</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span>
  <span class="token key atrule">interaction</span><span class="token punctuation">:</span> <span class="token boolean important">True</span>
  <span class="token key atrule">pooling_type</span><span class="token punctuation">:</span> mean
  <span class="token key atrule">fuse_k</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">point_cloud_range</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-25.6</span><span class="token punctuation">,</span> <span class="token number">-2</span><span class="token punctuation">,</span> <span class="token number">51.2</span><span class="token punctuation">,</span> <span class="token number">25.6</span><span class="token punctuation">,</span> <span class="token number">4.4</span><span class="token punctuation">]</span>
  <span class="token key atrule">voxel_size</span><span class="token punctuation">:</span> <span class="token number">0.2</span>
  <span class="token key atrule">search_k</span><span class="token punctuation">:</span> <span class="token number">8</span>
  <span class="token key atrule">feat_relation</span><span class="token punctuation">:</span> <span class="token boolean important">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>Completion</code>部分包含了与完备性任务相关的参数设置。</li>
<li><code>model_name</code>: 完备性模型的名称，这里使用SSCNet。</li>
<li><code>m</code>: SSCNet模型的参数，这里设置为32。</li>
<li><code>feeding</code>: 输入数据的类型，这里设置为”both”，表示同时输入特征和概率。</li>
<li><code>no_fuse_feat</code>: 是否不融合特征，设置为”False”表示融合特征。</li>
<li><code>block_residual</code>: 是否使用块残差，设置为”True”表示使用。</li>
<li><code>block_reps</code>: 块的重复次数，这里设置为2。</li>
<li><code>use_coords</code>: 是否使用坐标信息，设置为”False”表示不使用。</li>
<li><code>mode</code>: 模式设置，这里设置为0。</li>
<li><code>full_scale</code>: 完全尺度范围的设置。</li>
<li><code>interaction</code>: 是否启用交互，设置为”True”表示启用。</li>
<li><code>pooling_type</code>: 池化类型，这里设置为”mean”。</li>
<li><code>fuse_k</code>: 融合参数k的设置。</li>
<li><code>point_cloud_range</code>: 点云范围的设置。</li>
<li><code>voxel_size</code>: 体素大小的设置。</li>
<li><code>search_k</code>: 搜索参数k的设置。</li>
<li><code>feat_relation</code>: 特征关系的设置，这里设置为”False”。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">TRAIN</span><span class="token punctuation">:</span>
  <span class="token key atrule">epochs</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">train_workers</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">optim</span><span class="token punctuation">:</span> Adam
  <span class="token key atrule">batch_size</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">learning_rate</span><span class="token punctuation">:</span> <span class="token number">0.001</span>
  <span class="token key atrule">lr_decay</span><span class="token punctuation">:</span> <span class="token number">0.7</span>
  <span class="token key atrule">decay_step</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">momentum</span><span class="token punctuation">:</span> <span class="token number">0.9</span>
  <span class="token key atrule">weight_decay</span><span class="token punctuation">:</span> <span class="token number">0.0001</span>
  <span class="token key atrule">save_freq</span><span class="token punctuation">:</span> <span class="token number">16</span>
  <span class="token key atrule">uncertainty_loss</span><span class="token punctuation">:</span> <span class="token boolean important">True</span>
  <span class="token key atrule">loss_weight</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span>
  <span class="token key atrule">pretrain_path</span><span class="token punctuation">:</span>
  <span class="token key atrule">train_from</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">seg_num_per_class</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">55437630</span><span class="token punctuation">,</span> <span class="token number">320797</span><span class="token punctuation">,</span> <span class="token number">541736</span><span class="token punctuation">,</span> <span class="token number">2578735</span><span class="token punctuation">,</span> <span class="token number">3274484</span><span class="token punctuation">,</span> <span class="token number">552662</span><span class="token punctuation">,</span> <span class="token number">184064</span><span class="token punctuation">,</span> <span class="token number">78858</span><span class="token punctuation">,</span> <span class="token number">240942562</span><span class="token punctuation">,</span> <span class="token number">17294618</span><span class="token punctuation">,</span> <span class="token number">170599734</span><span class="token punctuation">,</span> <span class="token number">6369672</span><span class="token punctuation">,</span> <span class="token number">230413074</span><span class="token punctuation">,</span> <span class="token number">101130274</span><span class="token punctuation">,</span> <span class="token number">476491114</span><span class="token punctuation">,</span> <span class="token number">9833174</span><span class="token punctuation">,</span> <span class="token number">129609852</span><span class="token punctuation">,</span> <span class="token number">4506626</span><span class="token punctuation">,</span> <span class="token number">1168181</span><span class="token punctuation">]</span>
  <span class="token key atrule">complt_num_per_class</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">7632350044</span><span class="token punctuation">,</span> <span class="token number">15783539</span><span class="token punctuation">,</span>  <span class="token number">125136</span><span class="token punctuation">,</span> <span class="token number">118809</span><span class="token punctuation">,</span> <span class="token number">646799</span><span class="token punctuation">,</span> <span class="token number">821951</span><span class="token punctuation">,</span> <span class="token number">262978</span><span class="token punctuation">,</span> <span class="token number">283696</span><span class="token punctuation">,</span> <span class="token number">204750</span><span class="token punctuation">,</span> <span class="token number">61688703</span><span class="token punctuation">,</span> <span class="token number">4502961</span><span class="token punctuation">,</span> <span class="token number">44883650</span><span class="token punctuation">,</span> <span class="token number">2269923</span><span class="token punctuation">,</span> <span class="token number">56840218</span><span class="token punctuation">,</span> <span class="token number">15719652</span><span class="token punctuation">,</span> <span class="token number">158442623</span><span class="token punctuation">,</span> <span class="token number">2061623</span><span class="token punctuation">,</span> <span class="token number">36970522</span><span class="token punctuation">,</span> <span class="token number">1151988</span><span class="token punctuation">,</span> <span class="token number">334146</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>TRAIN</code>部分包含了训练相关的参数设置。</li>
<li><code>epochs</code>: 训练的轮数，这里设置为100。</li>
<li><code>train_workers</code>: 数据加载器的工作进程数，这里设置为10。</li>
<li><code>optim</code>: 优化器的选择，这里使用Adam。</li>
<li><code>batch_size</code>: 批量大小，这里设置为2。</li>
<li><code>learning_rate</code>: 学习率，这里设置为0.001。</li>
<li><code>lr_decay</code>: 学习率的衰减率，这里设置为0.7。</li>
<li><code>decay_step</code>: 学习率衰减的步数，这里设置为10。</li>
<li><code>momentum</code>: 优化器的动量，这里设置为0.9。</li>
<li><code>weight_decay</code>: 权重衰减，这里设置为0.0001。</li>
<li><code>save_freq</code>: 模型保存的频率，这里设置为16。</li>
<li><code>uncertainty_loss</code>: 是否启用不确定性损失，设置为”True”表示启用。</li>
<li><code>loss_weight</code>: 损失的权重，这里是一个列表，包括语义损失和完备性损失的权重。</li>
<li><code>pretrain_path</code>: 预训练模型的路径。</li>
<li><code>train_from</code>: 从哪一轮训练开始，这里设置为0。</li>
<li><code>seg_num_per_class</code>: 每个类别的语义分割样本数量。</li>
<li><code>complt_num_per_class</code>: 每个类别的完备性样本数量。</li>
</ul>
<p>这个配置文件包含了JS3CNet网络的各种参数和设置，用于训练和测试语义分割和完备性任务。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yanx27/JS3C-Net/blob/main/train.py">J3SC_Net </a>是 JS3CNet 网络的核心部分，主要用于同时处理语义分割和点云完备性分割任务。它是一个继承自 PyTorch 的 <code>nn.Module</code> 的模型，下面将对其进行详细介绍：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">J3SC_Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>seg_head <span class="token operator">=</span> seg_model<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>complet_head <span class="token operator">=</span> complet_model<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>voxelpool <span class="token operator">=</span> model_utils<span class="token punctuation">.</span>VoxelPooling<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>seg_sigma <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uniform_<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>complet_sigma <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uniform_<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        seg_inputs<span class="token punctuation">,</span> complet_inputs<span class="token punctuation">,</span> _ <span class="token operator">=</span> x

        <span class="token comment"># 分割头部分</span>
        seg_output<span class="token punctuation">,</span> feat <span class="token operator">=</span> self<span class="token punctuation">.</span>seg_head<span class="token punctuation">(</span>seg_inputs<span class="token punctuation">)</span>

        <span class="token comment"># 完备性头部分</span>
        coords <span class="token operator">=</span> complet_inputs<span class="token punctuation">[</span><span class="token string">'complet_coords'</span><span class="token punctuation">]</span>
        coords <span class="token operator">=</span> coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'DATA'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'dataset'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'SemanticKITTI'</span><span class="token punctuation">:</span>
            coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">elif</span> args<span class="token punctuation">[</span><span class="token string">'DATA'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'dataset'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'SemanticPOSS'</span><span class="token punctuation">:</span>
            coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">31</span>

        <span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'Completion'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'feeding'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'both'</span><span class="token punctuation">:</span>
            feeding <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>seg_output<span class="token punctuation">,</span> feat<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> args<span class="token punctuation">[</span><span class="token string">'Completion'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'feeding'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'feat'</span><span class="token punctuation">:</span>
            feeding <span class="token operator">=</span> feat
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            feeding <span class="token operator">=</span> seg_output

        <span class="token comment"># 使用Voxelpool模块进行特征池化操作</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>voxelpool<span class="token punctuation">(</span>
            invoxel_xyz<span class="token operator">=</span>complet_inputs<span class="token punctuation">[</span><span class="token string">'complet_invoxel_features'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            invoxel_map<span class="token operator">=</span>complet_inputs<span class="token punctuation">[</span><span class="token string">'complet_invoxel_features'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            src_feat<span class="token operator">=</span>feeding<span class="token punctuation">,</span>
            voxel_center<span class="token operator">=</span>complet_inputs<span class="token punctuation">[</span><span class="token string">'voxel_centers'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">'Completion'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'no_fuse_feat'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            features<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
            features <span class="token operator">=</span> features<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 创建SparseConvTensor，用于点云完备性分割</span>
        batch_complet <span class="token operator">=</span> spconv<span class="token punctuation">.</span>SparseConvTensor<span class="token punctuation">(</span>
            features<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coords<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'Completion'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'full_scale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'TRAIN'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        batch_complet <span class="token operator">=</span> dataset<span class="token punctuation">.</span>sparse_tensor_augmentation<span class="token punctuation">(</span>batch_complet<span class="token punctuation">,</span> complet_inputs<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 使用完备性头部分进行点云完备性分割</span>
        complet_output <span class="token operator">=</span> self<span class="token punctuation">.</span>complet_head<span class="token punctuation">(</span>batch_complet<span class="token punctuation">)</span>

        <span class="token keyword">return</span> seg_output<span class="token punctuation">,</span> complet_output<span class="token punctuation">,</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>seg_sigma<span class="token punctuation">,</span> self<span class="token punctuation">.</span>complet_sigma<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>主要组成部分</strong>：</p>
<ol>
<li><p><code>seg_head</code> 和 <code>complet_head</code>：这是分割头和完备性头的模型，它们通过 <code>args</code> 参数配置，用于执行分割任务和完备性任务。这些模型的初始化在 <code>__init__</code> 方法中进行。</p>
</li>
<li><p><code>voxelpool</code> 模块：用于对特征进行池化操作。根据输入参数，它将输入特征和相关的信息池化成新的特征。</p>
</li>
<li><p><code>seg_sigma</code> 和 <code>complet_sigma</code>：这是可学习的参数，分别表示语义分割和完备性分割任务的不确定性。模型在训练过程中会学习这些参数。</p>
</li>
</ol>
<p><strong>前向传播（<code>forward</code> 方法）</strong>：</p>
<p>在前向传播中，<code>J3SC_Net</code> 接受一个输入 <code>x</code>，其中 <code>x</code> 包含了分割和完备性任务的输入。首先，模型通过语义分割头 (<code>seg_head</code>) 处理分割任务的输入数据 <code>seg_inputs</code>，生成 <code>seg_output</code> 和 <code>feat</code>。</p>
<p>然后，对完备性任务的输入数据进行处理。首先调整坐标 <code>coords</code>，然后根据 <code>args</code> 的配置选择适当的输入数据 <code>feeding</code>。接下来，使用 <code>voxelpool</code> 模块对特征进行池化操作，生成 <code>features</code>。</p>
<p>最后，将生成的 <code>features</code> 传递给完备性头部分 (<code>complet_head</code>) 进行点云完备性分割。模型的输出包括语义分割结果 <code>seg_output</code> 和点云完备性分割结果 <code>complet_output</code>，以及模型学习的不确定性参数 <code>seg_sigma</code> 和 <code>complet_sigma</code>。</p>
<p><code>J3SC_Net</code> 模型将同时执行语义分割和点云完备性分割任务，使其成为 JS3CNet 网络的核心组件。这种多任务学习可以在处理点云数据时提高效率和性能。</p>
<p><code>SSCNet</code> 是一个用于点云完备性分割的神经网络模型，它是 JS3CNet 中完备性分割部分的模型。下面将详细介绍 <code>SSCNet</code> 模型的主要组成部分。</p>
<h4 id="SSCNet-Decoder"><a href="#SSCNet-Decoder" class="headerlink" title="SSCNet_Decoder"></a>SSCNet_Decoder</h4><p><code>SSCNet_Decoder</code> 是 <code>SSCNet</code> 的解码器部分。它主要负责将输入特征映射到点云的完备性分割结果。该解码器采用了类似 U-Net 架构的设计，分为不同的块（Block），其中包括卷积、批归一化和 ReLU 激活函数层。以下是 <code>SSCNet_Decoder</code> 中各个块的主要部分：</p>
<ul>
<li><p>Block 1：包括两个卷积层，每个卷积层后接批归一化和 ReLU 激活函数。该块的输出与一个残差块相加，并经过最大池化。</p>
</li>
<li><p>Block 2：与 Block 1 类似，包括两个卷积层，批归一化和 ReLU 激活函数。输出与残差块相加。</p>
</li>
<li><p>Block 3：包括两个卷积层，批归一化和 ReLU 激活函数。没有残差连接。</p>
</li>
<li><p>Block 4：包括两个卷积层，批归一化和 ReLU 激活函数。没有残差连接。</p>
</li>
<li><p>Block 5：包括两个卷积层，批归一化和 ReLU 激活函数。没有残差连接。</p>
</li>
<li><p>Prediction：该块用于生成最终的点云完备性分割结果。它包括两个卷积层，最终输出预测结果。</p>
</li>
</ul>
<p><code>SSCNet_Decoder</code> 的各个块逐渐提取并综合特征，最终生成点云完备性分割的预测结果。</p>
<h4 id="SSCNet"><a href="#SSCNet" class="headerlink" title="SSCNet"></a>SSCNet</h4><p><code>SSCNet</code> 是完备性分割网络的主要模型。它包含以下组件：</p>
<ul>
<li><p><code>Decoder</code>：前面介绍的 <code>SSCNet_Decoder</code>，用于点云完备性分割任务。它将输入的点云特征进行解码操作，最终生成点云完备性分割的预测结果。</p>
</li>
<li><p><code>upsample</code>：这是上采样模块，用于上采样点云完备性分割的结果，以便与语义分割结果相融合。</p>
</li>
<li><p><code>interaction_module</code>（可选）：如果配置中启用了交互模块（<code>args[&#39;Completion&#39;][&#39;interaction&#39;]</code> 为 <code>True</code>），则此组件用于执行点云之间的交互操作。这可以有助于改进点云完备性分割性能。</p>
</li>
</ul>
<p><code>SSCNet</code> 的前向传播过程首先将输入特征通过 <code>Decoder</code> 进行解码，然后根据配置选择是否执行交互操作，最后经过上采样模块生成最终的点云完备性分割结果。</p>
<p>这些组件一起构成了 <code>SSCNet</code> 模型，用于处理点云数据的完备性分割任务。</p>
<p><code>complet_head</code> 是用于点云语义完成任务的头部模块。它定义了一个 Unet 模型，用于处理 3D 点云数据。</p>
<h4 id="类-Unet"><a href="#类-Unet" class="headerlink" title="类 Unet"></a>类 <code>Unet</code></h4><p>这个类包含了 Unet 模型的构建和前向传播方法。以下是类 <code>Unet</code> 的详细分析：</p>
<ol>
<li><p><strong>构造方法 <code>__init__</code></strong>:</p>
<ul>
<li>这个方法接受一个配置参数 <code>config</code>，用于指定模型的各种参数和配置信息。</li>
<li><code>m</code> 是配置中指定的通道数。</li>
<li><code>input_dim</code> 是输入数据的维度，如果配置中指定了使用坐标信息 (<code>use_coords</code> 为 <code>True</code>)，则为 4，否则为 1。</li>
<li><code>sparseModel</code> 是一个 SparseConvNet 序列模型，它包含了 Unet 架构，包括编码器、解码器和跳跃连接部分。</li>
</ul>
</li>
<li><p><strong>前向传播方法 <code>forward</code></strong>:</p>
<ul>
<li>这个方法接受输入 <code>x</code>，其中 <code>x</code> 包含 <code>seg_coords</code> 和 <code>seg_features</code>。</li>
<li><code>x</code> 被传递给 <code>sparseModel</code>，这一步会进行 Unet 架构的前向传播。</li>
<li>如果在配置中启用了 <code>interaction</code>，则模型还会执行特征嵌入过程，以处理点云的交互信息。</li>
<li>最后，模型执行线性变换，将特征映射到类别预测空间，并返回预测结果以及特征信息。</li>
</ul>
</li>
</ol>
<h4 id="函数-Merge-tbl"><a href="#函数-Merge-tbl" class="headerlink" title="函数 Merge(tbl)"></a>函数 <code>Merge(tbl)</code></h4><p>这个函数是用于处理训练数据的工具函数，它接受一个包含多个样本数据的列表 <code>tbl</code>。</p>
<ol>
<li>函数通过迭代遍历每个样本数据，并从每个样本中提取出所需的数据，分别处理分割和完成任务的部分。</li>
<li>分割部分的数据包括坐标信息、标签和特征。</li>
<li>完成部分的数据包括点云坐标、输入数据、体素中心坐标、有效性信息、标签、统计信息以及点云体素特征。</li>
<li>这些数据被整理成适合输入到模型的格式，并以字典形式返回，包括 <code>seg_inputs</code> 和 <code>complet_inputs</code>。</li>
<li>还返回了一个包含样本文件名的列表，用于后续的分析和处理。</li>
</ol>
<p>总之，<code>complet_head</code> 中的代码定义了一个用于点云语义完成任务的 Unet 模型，同时提供了一个数据处理函数 <code>Merge(tbl)</code>，用于将原始数据整理成适合输入模型的格式。</p>
<p><code>model_utils.py</code> 包含了用于模型训练和实用工具的函数和类。下面是该文件中主要部分的详细分析：</p>
<ol>
<li><p><code>checkpoint_restore(model, exp_name, use_cuda=True, train_from=0)</code>:</p>
<ul>
<li>此函数用于从检查点文件中恢复模型的参数。</li>
<li><code>model</code> 是模型对象，<code>exp_name</code> 是实验名称，<code>use_cuda</code> 是是否使用 CUDA 运行模型，<code>train_from</code> 是指定的训练起始时期。</li>
<li>函数会查找以 “.pth” 结尾的模型检查点文件，找到最新的模型检查点并加载到模型中。</li>
<li>如果指定了 <code>train_from</code> 大于0，会从该时期开始训练。</li>
<li>函数返回模型训练的当前时期。</li>
</ul>
</li>
<li><p><code>VoxelPooling</code>:</p>
<ul>
<li>这是一个用于点云特征池化的自定义模块。</li>
<li>通过此模块，可以将点云体素汇聚为单一特征。</li>
<li>模块会对点云体素进行池化操作，并考虑了点云体素之间的关系。</li>
</ul>
</li>
<li><p><code>Loss</code>:</p>
<ul>
<li>这是一个自定义的损失函数模块，用于计算训练中的损失。</li>
<li>它计算分割损失和完成损失，支持带权重的损失计算。</li>
<li>如果 <code>uncertainty_loss</code> 被启用，还会计算损失的不确定性。</li>
</ul>
</li>
<li><p><code>interaction_module</code>:</p>
<ul>
<li>这是一个模块，用于模型中的点云交互。</li>
<li>它允许点云之间的特征交互，可以选择使用特征关系或直接的插值方法。</li>
<li>此模块通过模型的前向传播执行点云特征的交互操作。</li>
</ul>
</li>
<li><p><code>ResidualBlock</code>, <code>VGGBlock</code>, <code>UBlock</code>:</p>
<ul>
<li>这些模块用于构建模型的特定类型的块，如残差块、VGG 块和 U 块。</li>
<li>这些块用于构建点云处理模型的不同组件。</li>
</ul>
</li>
<li><p>其他工具函数:</p>
<ul>
<li>文件中还包括了其他用于文件读写、坐标转换、特征提取和其他辅助功能的函数。</li>
</ul>
</li>
</ol>
<p>总之，<code>model_utils.py</code> 包含了模型训练中的损失函数、模型恢复函数、自定义模块和工具函数，这些组成部分用于构建和训练点云处理模型。</p>
<h2 id="MonoScene"><a href="#MonoScene" class="headerlink" title="MonoScene"></a>MonoScene</h2><p>一种能在室内与室外场景均可使用的单目 SSC 方案：</p>
<ul>
<li>提出一种将 2D 特征投影到 3D 的方法： FLoSP </li>
<li>提出一种  3D Context Relation Prior （3D CRP） 提升网络的上下文意识</li>
<li>新的SSC损失函数，用于优化场景类亲和力（affinity）和局部锥体（frustum）比例</li>
</ul>
<p>代码链接： <a target="_blank" rel="noopener" href="https://github.com/astra-vision/MonoScene">MonoScene: Monocular 3D Semantic Scene Completion</a>, CVPR 2022</p>
<p><img src="/pic/MonoScence.png"></p>
<p>Monoscene  网络流程</p>
<ul>
<li>输入 2d 图片，经过 2d unet 提取多层次的特征</li>
<li>Features Line of Sight Projection module (FLoSP) 用于将 2d 特征提升到 3d 位置上，增强信息流并实现2D-3D分离</li>
<li>3D Context Relation Prior （3D CRP） 用于增强长距离的上下文信息提取</li>
<li>loss 优化：Scene-Class Affinity Loss：提升类内和类间的场景方面度量；Frustum Proportion Loss：对齐局部截头体中的类分布，提供超越场景遮挡的监督信息</li>
</ul>
<p>网络结构</p>
<ul>
<li>2D unet：EfficientNetB7 用于提取图像特征</li>
<li>3D UNets：2层 encoder-decoder 结构，用于提取 3d 特征</li>
<li>completion head：3D ASPP 结构和 softmax 层，用于处理 3D UNet 输出得到3d场景 completion 结果</li>
</ul>
<h3 id="代码介绍"><a href="#代码介绍" class="headerlink" title="代码介绍"></a>代码介绍</h3><p><a target="_blank" rel="noopener" href="https://github.com/astra-vision/MonoScene/blob/master/monoscene/models/monoscene.py">monoscene.py</a>使用PyTorch Lightning构建的一个名为<code>MonoScene</code>的模型类，用于单目深度估计和场景分割的任务。以下是该类的主要组件和功能的详细解释：</p>
<ol>
<li><p><strong>初始化方法</strong> (<code>__init__</code>)：这是类的构造方法，在创建<code>MonoScene</code>对象时被调用。它接受多个参数，包括类别数 (<code>n_classes</code>)、类别名称 (<code>class_names</code>)、特征数量 (<code>feature</code>)、类别权重 (<code>class_weights</code>) 等，用于初始化模型的各种参数和组件。其中的许多参数用于配置损失函数和训练过程中的各种选项。这里还创建了一个UNet 2D模型和多个FLoSP (Feature Learning from Single Point) 模型，用于3D场景估计。</p>
</li>
<li><p><strong>前向传播方法</strong> (<code>forward</code>)：<code>forward</code> 方法定义了如何计算模型的前向传播。它接受一个输入批次 (<code>batch</code>)，包括图像 (<code>img</code>)，并根据输入数据的尺寸进行前向传播计算。首先，通过UNet 2D模型 (<code>net_rgb</code>) 处理输入图像，然后根据尺度变化对图像进行3D投影，最终由UNet 3D模型 (<code>net_3d_decoder</code>) 进行3D场景估计。前向传播的结果保存在<code>out</code>变量中。</p>
</li>
<li><p><strong><code>step</code> 方法</strong>：<code>step</code> 方法执行了训练、验证和测试过程中的通用逻辑。它接受一个数据批次 (<code>batch</code>)、一个步骤类型 (<code>step_type</code>) 和一个度量指标 (<code>metric</code>)。在该方法中，对输入数据进行前向传播，计算并更新损失，同时也更新度量指标。这部分逻辑用于在训练、验证和测试时共享相同的操作。</p>
</li>
<li><p><strong>训练步骤</strong> (<code>training_step</code>)：<code>training_step</code> 方法是PyTorch Lightning中定义训练步骤的函数。它调用了<code>step</code> 方法，以及指定了步骤类型 (“train”) 和训练度量指标 (<code>self.train_metrics</code>)。</p>
</li>
<li><p><strong>验证步骤</strong> (<code>validation_step</code>) 和 <strong>验证结束方法</strong> (<code>validation_epoch_end</code>)：这两个方法用于在验证集上进行评估。<code>validation_step</code> 方法执行一个验证步骤，计算损失和更新验证度量指标 (<code>self.val_metrics</code>)。<code>validation_epoch_end</code> 方法在每个验证周期结束后，从度量指标中获取评估结果并进行记录。</p>
</li>
<li><p><strong>测试步骤</strong> (<code>test_step</code>) 和 <strong>测试结束方法</strong> (<code>test_epoch_end</code>)：这两个方法用于在测试集上进行评估，与验证过程类似。</p>
</li>
<li><p><strong>配置优化器</strong> (<code>configure_optimizers</code>)：在此方法中配置了模型的优化器和学习率调度器。根据数据集的不同（NYU或KITTI），选择了不同的优化器和学习率调度策略。</p>
</li>
<li><p><strong>指标记录和日志输出</strong>：在不同的步骤中，通过<code>self.log</code> 方法记录和输出训练、验证和测试的损失、IoU、精确度等度量指标。这些度量指标在每个epoch结束时会被重置，以便记录下一个epoch的结果。</p>
</li>
</ol>
<p>这段代码使用了PyTorch Lightning来规范化训练和评估流程，提供了清晰的组织结构，以及易于扩展和修改的接口，使其更容易适应不同的任务和数据集。根据您的需求，可以调整和扩展这个类来满足您的具体任务。</p>
<p>让我们逐行解释<code>MonoScene</code>类中的代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pytorch_lightning <span class="token keyword">as</span> pl
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>models<span class="token punctuation">.</span>unet3d_nyu <span class="token keyword">import</span> UNet3D <span class="token keyword">as</span> UNet3DNYU
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>models<span class="token punctuation">.</span>unet3d_kitti <span class="token keyword">import</span> UNet3D <span class="token keyword">as</span> UNet3DKitti
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>sscMetrics <span class="token keyword">import</span> SSCMetrics
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>ssc_loss <span class="token keyword">import</span> sem_scal_loss<span class="token punctuation">,</span> CE_ssc_loss<span class="token punctuation">,</span> KL_sep<span class="token punctuation">,</span> geo_scal_loss
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>models<span class="token punctuation">.</span>flosp <span class="token keyword">import</span> FLoSP
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>CRP_loss <span class="token keyword">import</span> compute_super_CP_multilabel_loss
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> monoscene<span class="token punctuation">.</span>models<span class="token punctuation">.</span>unet2d <span class="token keyword">import</span> UNet2D
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler <span class="token keyword">import</span> MultiStepLR<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些行导入所需的Python库和模块，包括PyTorch、PyTorch Lightning、模型类、损失函数和其他依赖项。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MonoScene</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span>LightningModule<span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这一行定义了一个名为<code>MonoScene</code>的PyTorch Lightning模型类，它继承自<code>pl.LightningModule</code>，这是PyTorch Lightning中定义自定义模型的基类。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    n_classes<span class="token punctuation">,</span>
    class_names<span class="token punctuation">,</span>
    feature<span class="token punctuation">,</span>
    class_weights<span class="token punctuation">,</span>
    project_scale<span class="token punctuation">,</span>
    full_scene_size<span class="token punctuation">,</span>
    dataset<span class="token punctuation">,</span>
    n_relations<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
    context_prior<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    fp_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    project_res<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    frustum_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
    relation_loss<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    CE_ssc_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    geo_scal_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    sem_scal_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    lr<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span>
    weight_decay<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是<code>MonoScene</code>类的构造方法 (<code>__init__</code>)。它接受许多参数，这些参数用于配置模型的不同方面，如类别数、类别名称、特征数量、损失权重、训练选项等。这些参数被用于初始化模型的各个组件和超参数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这一行调用了基类的构造方法，即<code>pl.LightningModule</code>的构造方法。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>project_res <span class="token operator">=</span> project_res
self<span class="token punctuation">.</span>fp_loss <span class="token operator">=</span> fp_loss
self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> dataset
self<span class="token punctuation">.</span>context_prior <span class="token operator">=</span> context_prior
self<span class="token punctuation">.</span>frustum_size <span class="token operator">=</span> frustum_size
self<span class="token punctuation">.</span>class_names <span class="token operator">=</span> class_names
self<span class="token punctuation">.</span>relation_loss <span class="token operator">=</span> relation_loss
self<span class="token punctuation">.</span>CE_ssc_loss <span class="token operator">=</span> CE_ssc_loss
self<span class="token punctuation">.</span>sem_scal_loss <span class="token operator">=</span> sem_scal_loss
self<span class="token punctuation">.</span>geo_scal_loss <span class="token operator">=</span> geo_scal_loss
self<span class="token punctuation">.</span>project_scale <span class="token operator">=</span> project_scale
self<span class="token punctuation">.</span>class_weights <span class="token operator">=</span> class_weights
self<span class="token punctuation">.</span>lr <span class="token operator">=</span> lr
self<span class="token punctuation">.</span>weight_decay <span class="token operator">=</span> weight_decay<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些行将构造方法中传入的参数赋值给对象的属性，以便它们可以在整个类中使用。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>projects <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
self<span class="token punctuation">.</span>scale_2ds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>  <span class="token comment"># 2D scales</span>
<span class="token keyword">for</span> scale_2d <span class="token keyword">in</span> self<span class="token punctuation">.</span>scale_2ds<span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>projects<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> FLoSP<span class="token punctuation">(</span>
        full_scene_size<span class="token punctuation">,</span> project_scale<span class="token operator">=</span>self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span> dataset<span class="token operator">=</span>self<span class="token punctuation">.</span>dataset
    <span class="token punctuation">)</span>
self<span class="token punctuation">.</span>projects <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleDict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>projects<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分初始化了模型的<code>projects</code>属性，其中包含多个FLoSP模型，用于将2D特征投影到3D场景。不同的投影比例 (<code>scale_2d</code>) 在这里被迭代，为每个比例创建一个FLoSP模型，并将它们存储在<code>projects</code>字典中。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>n_classes <span class="token operator">=</span> n_classes
<span class="token keyword">if</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"NYU"</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>net_3d_decoder <span class="token operator">=</span> UNet3DNYU<span class="token punctuation">(</span>
        self<span class="token punctuation">.</span>n_classes<span class="token punctuation">,</span>
        nn<span class="token punctuation">.</span>BatchNorm3d<span class="token punctuation">,</span>
        n_relations<span class="token operator">=</span>n_relations<span class="token punctuation">,</span>
        feature<span class="token operator">=</span>feature<span class="token punctuation">,</span>
        full_scene_size<span class="token operator">=</span>full_scene_size<span class="token punctuation">,</span>
        context_prior<span class="token operator">=</span>context_prior<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token keyword">elif</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"kitti"</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>net_3d_decoder <span class="token operator">=</span> UNet3DKitti<span class="token punctuation">(</span>
        self<span class="token punctuation">.</span>n_classes<span class="token punctuation">,</span>
        nn<span class="token punctuation">.</span>BatchNorm3d<span class="token punctuation">,</span>
        project_scale<span class="token operator">=</span>project_scale<span class="token punctuation">,</span>
        feature<span class="token operator">=</span>feature<span class="token punctuation">,</span>
        full_scene_size<span class="token operator">=</span>full_scene_size<span class="token punctuation">,</span>
        context_prior<span class="token operator">=</span>context_prior<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分初始化了模型的3D解码器 (<code>net_3d_decoder</code>)，根据数据集的类型 (“NYU” 或 “kitti”) 选择不同的UNet 3D模型。该解码器将用于对3D场景进行估计。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>net_rgb <span class="token operator">=</span> UNet2D<span class="token punctuation">.</span>build<span class="token punctuation">(</span>out_feature<span class="token operator">=</span>feature<span class="token punctuation">,</span> use_decoder<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这一行创建了模型的2D UNet模型 (<code>net_rgb</code>)，该模型用于处理输入图像，其中的<code>feature</code>参数指定了模型的特征数量。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># log hyperparameters</span>
self<span class="token punctuation">.</span>save_hyperparameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这一行记录了模型的超参数，以便后续可以查看它们。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>train_metrics <span class="token operator">=</span> SSCMetrics<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_classes<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>val_metrics <span class="token operator">=</span> SSCMetrics<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_classes<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>test_metrics <span class="token operator">=</span> SSCMetrics<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_classes<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这些行初始化了训练、验证和测试度量指标 (<code>train_metrics</code>, <code>val_metrics</code>, <code>test_metrics</code>)，用于跟踪模型性能。</p>
<p>这只是构造方法的设置部分。整个<code>MonoScene</code>类的构造方法用于初始化模型的各个组件和超参数。在下面的部分中，将解释类中的其他方法。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">"img"</span><span class="token punctuation">]</span>
    bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    out <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    x_rgb <span class="token operator">=</span> self<span class="token punctuation">.</span>net_rgb<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    x3ds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x3d <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">for</span> scale_2d <span class="token keyword">in</span> self<span class="token punctuation">.</span>project_res<span class="token punctuation">:</span>
            <span class="token comment"># project features at each 2D scale to target 3D scale</span>
            scale_2d <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span>
            projected_pix <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">"projected_pix_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>project_scale<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            fov_mask <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">"fov_mask_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>project_scale<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> x3d <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                x3d <span class="token operator">=</span> self<span class="token punctuation">.</span>projects<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
                    x_rgb<span class="token punctuation">[</span><span class="token string">"1_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    projected_pix <span class="token operator">//</span> scale_2d<span class="token punctuation">,</span>
                    fov_mask<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                x3d <span class="token operator">+=</span> self<span class="token punctuation">.</span>projects<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
                    x_rgb<span class="token punctuation">[</span><span class="token string">"1_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>scale_2d<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    projected_pix <span class="token operator">//</span> scale_2d<span class="token punctuation">,</span>
                    fov_mask<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
        x3ds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x3d<span class="token punctuation">)</span>
    input_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"x3d"</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>x3ds<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    out <span class="token operator">=</span> self<span class="token punctuation">.</span>net_3d_decoder<span class="token punctuation">(</span>input_dict<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是模型的前向传播函数 <code>forward</code>。在这个函数中，输入图像 <code>img</code> 被传递给 2D UNet 模型 <code>net_rgb</code> 以提取特征。然后，特征将根据指定的投影比例 (<code>self.project_res</code>) 投影到3D场景中。对于每个输入样本，它会循环遍历不同的投影比例，并调用FLoSP模型 (<code>self.projects</code>) 来执行特征投影。最终，投影的特征将被传递给3D解码器 <code>net_3d_decoder</code> 进行3D场景估计。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> step_type<span class="token punctuation">,</span> metric<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">"img"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    loss <span class="token operator">=</span> <span class="token number">0</span>
    out_dict <span class="token operator">=</span> self<span class="token punctuation">(</span>batch<span class="token punctuation">)</span>
    ssc_pred <span class="token operator">=</span> out_dict<span class="token punctuation">[</span><span class="token string">"ssc_logit"</span><span class="token punctuation">]</span>
    target <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">"target"</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>context_prior<span class="token punctuation">:</span>
        P_logits <span class="token operator">=</span> out_dict<span class="token punctuation">[</span><span class="token string">"P_logits"</span><span class="token punctuation">]</span>
        CP_mega_matrices <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">"CP_mega_matrices"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>relation_loss<span class="token punctuation">:</span>
            loss_rel_ce <span class="token operator">=</span> compute_super_CP_multilabel_loss<span class="token punctuation">(</span>
                P_logits<span class="token punctuation">,</span> CP_mega_matrices
            <span class="token punctuation">)</span>
            loss <span class="token operator">+=</span> loss_rel_ce
            self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
                step_type <span class="token operator">+</span> <span class="token string">"/loss_relation_ce_super"</span><span class="token punctuation">,</span>
                loss_rel_ce<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法 <code>step</code> 用于执行训练、验证和测试步骤的公共逻辑。它接受批量数据 <code>batch</code>、步骤类型 <code>step_type</code>（如 “train”、”val”、”test”）和度量对象 <code>metric</code> 作为参数。在这个方法中，模型的前向传播被调用，并计算损失 <code>loss</code>。具体的损失计算依赖于模型的配置和目标。在这里，根据模型的配置，可以计算包括关系损失 (<code>loss_rel_ce</code>) 的不同损失项。如果启用了关系损失 (<code>self.relation_loss</code>)，则将计算关系损失并将其添加到总损失中。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">class_weight <span class="token operator">=</span> self<span class="token punctuation">.</span>class_weights<span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">"img"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> self<span class="token punctuation">.</span>CE_ssc_loss<span class="token punctuation">:</span>
    loss_ssc <span class="token operator">=</span> CE_ssc_loss<span class="token punctuation">(</span>ssc_pred<span class="token punctuation">,</span> target<span class="token punctuation">,</span> class_weight<span class="token punctuation">)</span>
    loss <span class="token operator">+=</span> loss_ssc
    self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
        step_type <span class="token operator">+</span> <span class="token string">"/loss_ssc"</span><span class="token punctuation">,</span>
        loss_ssc<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token keyword">if</span> self<span class="token punctuation">.</span>sem_scal_loss<span class="token punctuation">:</span>
    loss_sem_scal <span class="token operator">=</span> sem_scal_loss<span class="token punctuation">(</span>ssc_pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    loss <span class="token operator">+=</span> loss_sem_scal
    self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
        step_type <span class="token operator">+</span> <span class="token string">"/loss_sem_scal"</span><span class="token punctuation">,</span>
        loss_sem_scal<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token keyword">if</span> self<span class="token punctuation">.</span>geo_scal_loss<span class="token punctuation">:</span>
    loss_geo_scal <span class="token operator">=</span> geo_scal_loss<span class="token punctuation">(</span>ssc_pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    loss <span class="token operator">+=</span> loss_geo_scal
    self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
        step_type <span class="token operator">+</span> <span class="token string">"/loss_geo_scal"</span><span class="token punctuation">,</span>
        loss_geo_scal<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这一部分中，根据模型的配置，计算了交叉熵损失 (<code>loss_ssc</code>)、语义分割损失 (<code>loss_sem_scal</code>) 和几何尺度损失 (<code>loss_geo_scal</code>)。这些损失用于对模型进行监督训练，以便它能够学习适应输入数据并进行3D场景估计。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>fp_loss <span class="token keyword">and</span> step_type <span class="token operator">!=</span> <span class="token string">"test"</span><span class="token punctuation">:</span>
    frustums_masks <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">"frustums_masks"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    frustums_class_dists <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>
        batch<span class="token punctuation">[</span><span class="token string">"frustums_class_dists"</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (bs, n_frustums, n_classes)</span>
    n_frustums <span class="token operator">=</span> frustums_class_dists<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    pred_prob <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>ssc_pred<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    batch_cnt <span class="token operator">=</span> frustums_class_dists<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># (n_frustums, n_classes)</span>

    frustum_loss <span class="token operator">=</span> <span class="token number">0</span>
    frustum_nonempty <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> frus <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_frustums<span class="token punctuation">)</span><span class="token punctuation">:</span>
        frustum_mask <span class="token operator">=</span> frustums_masks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> frus<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        prob <span class="token operator">=</span> frustum_mask <span class="token operator">*</span> pred_prob  <span class="token comment"># bs, n_classes, H, W, D</span>
        prob <span class="token operator">=</span> prob<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_classes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        prob <span class="token operator">=</span> prob<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_classes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cum_prob <span class="token operator">=</span> prob<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># n_classes</span>

        total_cnt <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>batch_cnt<span class="token punctuation">[</span>frus<span class="token punctuation">]</span><span class="token punctuation">)</span>
        total_prob <span class="token operator">=</span> prob<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> total_prob <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">and</span> total_cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            frustum_target_proportion <span class="token operator">=</span> batch_cnt<span class="token punctuation">[</span>frus<span class="token punctuation">]</span> <span class="token operator">/</span> total_cnt
            cum_prob <span class="token operator">=</span> cum_prob <span class="token operator">/</span> total_prob  <span class="token comment"># n_classes</span>
            frustum_loss_i <span class="token operator">=</span> KL_sep<span class="token punctuation">(</span>cum_prob<span class="token punctuation">,</span> frustum_target_proportion<span class="token punctuation">)</span>
            frustum_loss <span class="token operator">+=</span> frustum_loss_i
            frustum_nonempty <span class="token operator">+=</span> <span class="token number">1</span>
    frustum_loss <span class="token operator">=</span> frustum_loss <span class="token operator">/</span> frustum_nonempty
    loss <span class="token operator">+=</span> frustum_loss
    self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
        step_type <span class="token operator">+</span> <span class="token string">"/loss_frustums"</span><span class="token punctuation">,</span>
        frustum_loss<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这部分代码中，计算</p>
<p>了与模型输出的SSC预测和输入数据中的frustum masks 相关的损失项。如果 <code>self.fp_loss</code> 被设置为 <code>True</code> 并且步骤类型不是 “test”，则将计算frustum损失。这个损失考虑了模型对视场的理解，以及模型的预测与输入数据的关系。</p>
<p>最后，损失项被添加到总损失 <code>loss</code> 中，并使用 <code>self.log</code> 方法记录损失，以便在训练期间进行监控。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">y_true <span class="token operator">=</span> target<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
y_pred <span class="token operator">=</span> ssc_pred<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
y_pred <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
metric<span class="token punctuation">.</span>add_batch<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span> y_true<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>step_type <span class="token operator">+</span> <span class="token string">"/loss"</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> on_epoch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里，真实标签和模型预测的标签用于计算模型性能指标，并将它们传递给 <code>metric</code> 对象。度量对象用于跟踪模型性能，并使用 <code>self.log</code> 方法记录损失。</p>
<p>这部分代码覆盖了<code>step</code> 方法中的主要逻辑，它是用于训练、验证和测试的公共代码。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">training_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> batch_idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>train_metrics<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个方法是用于训练的步骤。它调用了 <code>step</code> 方法，并传递了相应的参数。在训练期间，它还返回损失以供 PyTorch Lightning 进行后续的处理。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">validation_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> batch_idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>val_metrics<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个方法是验证步骤。它也调用了 <code>step</code> 方法，但不返回损失，而是将性能指标记录到验证度量对象 <code>val_metrics</code> 中。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">validation_epoch_end</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    metric_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"train"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>train_metrics<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>val_metrics<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> prefix<span class="token punctuation">,</span> metric <span class="token keyword">in</span> metric_list<span class="token punctuation">:</span>
        stats <span class="token operator">=</span> metric<span class="token punctuation">.</span>get_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> class_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
                <span class="token string">"&#123;&#125;_SemIoU/&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> class_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                stats<span class="token punctuation">[</span><span class="token string">"iou_ssc"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"&#123;&#125;/mIoU"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"iou_ssc_mean"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"&#123;&#125;/IoU"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"iou"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"&#123;&#125;/Precision"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"recall"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"&#123;&#125;/Recall"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"recall"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sync_dist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        metric<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法在验证周期结束时被调用，用于总结验证阶段的性能。它计算各个类别的语义分割IoU、平均IoU、IoU和精确度，并使用 <code>self.log</code> 方法记录这些度量值。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> batch_idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_metrics<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个方法是测试步骤，类似于验证步骤，它调用 <code>step</code> 方法并将性能指标记录到测试度量对象 <code>test_metrics</code> 中。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_epoch_end</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    classes <span class="token operator">=</span> self<span class="token punctuation">.</span>class_names
    metric_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_metrics<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> prefix<span class="token punctuation">,</span> metric <span class="token keyword">in</span> metric_list<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;======"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span>
        stats <span class="token operator">=</span> metric<span class="token punctuation">.</span>get_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>
            <span class="token string">"Precision=&#123;:.4f&#125;, Recall=&#123;:.4f&#125;, IoU=&#123;:.4f&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                stats<span class="token punctuation">[</span><span class="token string">"precision"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"recall"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> stats<span class="token punctuation">[</span><span class="token string">"iou"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"class IoU: &#123;&#125;, "</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>
            <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"&#123;:.4f&#125;, "</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                <span class="token operator">*</span><span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">"iou_ssc"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"mIoU=&#123;:.4f&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>stats<span class="token punctuation">[</span><span class="token string">"iou_ssc_mean"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        metric<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法在测试周期结束时被调用，用于总结测试阶段的性能。它打印了精确度、召回率、IoU 和类别IoU的信息，并将这些信息显示在控制台上。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">configure_optimizers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"NYU"</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>self<span class="token punctuation">.</span>weight_decay
        <span class="token punctuation">)</span>
        scheduler <span class="token operator">=</span> MultiStepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> milestones<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>optimizer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>scheduler<span class="token punctuation">]</span>
    <span class="token keyword">elif</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"kitti"</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>self<span class="token punctuation">.</span>weight_decay
        <span class="token punctuation">)</span>
        scheduler <span class="token operator">=</span> MultiStepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> milestones<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>optimizer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>scheduler<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法用于配置优化器和学习率调度器。根据数据集类型 (<code>self.dataset</code>)，它初始化一个AdamW优化器并将其与一个学习率调度器一起返回。调度器将在训练期间按照指定的里程碑来调整学习率。<br>这就是<code>MonoScene</code>类中的所有方法和逻辑的解释。该类代表了一个用于场景语义分割的PyTorch Lightning模型，它包括了许多用于定义前向传播、计算损失和跟踪性能的方法。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">class</span> <span class="token class-name">FLoSP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scene_size<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> project_scale<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scene_size <span class="token operator">=</span> scene_size
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> dataset
        self<span class="token punctuation">.</span>project_scale <span class="token operator">=</span> project_scale

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x2d<span class="token punctuation">,</span> projected_pix<span class="token punctuation">,</span> fov_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> x2d<span class="token punctuation">.</span>shape

        src <span class="token operator">=</span> x2d<span class="token punctuation">.</span>view<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        zeros_vec <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">)</span>
        src <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>src<span class="token punctuation">,</span> zeros_vec<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        pix_x<span class="token punctuation">,</span> pix_y <span class="token operator">=</span> projected_pix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> projected_pix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        img_indices <span class="token operator">=</span> pix_y <span class="token operator">*</span> w <span class="token operator">+</span> pix_x
        img_indices<span class="token punctuation">[</span><span class="token operator">~</span>fov_mask<span class="token punctuation">]</span> <span class="token operator">=</span> h <span class="token operator">*</span> w
        img_indices <span class="token operator">=</span> img_indices<span class="token punctuation">.</span>expand<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># c, HWD</span>
        src_feature <span class="token operator">=</span> torch<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> img_indices<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"NYU"</span><span class="token punctuation">:</span>
            x3d <span class="token operator">=</span> src_feature<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
                c<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            x3d <span class="token operator">=</span> x3d<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>dataset <span class="token operator">==</span> <span class="token string">"kitti"</span><span class="token punctuation">:</span>
            x3d <span class="token operator">=</span> src_feature<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
                c<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>scene_size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>project_scale<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        <span class="token keyword">return</span> x3d
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这段代码定义了一个名为 <code>FLoSP</code> 的 PyTorch 模块，它用于执行特征投影操作。FLoSP 的作用是将一个 2D 图像中的特征投影到 3D 空间中。让我们逐行解释这个模块的功能和实现：</p>
<ol>
<li><p><code>class FLoSP(nn.Module):</code>：定义了一个名为 <code>FLoSP</code> 的 PyTorch 模块，它继承自 <code>nn.Module</code>。</p>
</li>
<li><p><code>def __init__(self, scene_size, dataset, project_scale):</code>：初始化方法，接受三个参数：</p>
<ul>
<li><code>scene_size</code>：表示 3D 场景的大小（宽度、高度、深度）。</li>
<li><code>dataset</code>：表示数据集的名称，可以是 “NYU” 或 “kitti”。</li>
<li><code>project_scale</code>：表示投影的尺度，通常是 2 的幂次方，用于将 2D 特征图中的像素投影到 3D 空间。</li>
</ul>
</li>
<li><p><code>self.scene_size = scene_size</code>：将输入的 <code>scene_size</code> 存储为对象属性，以便在模块的其他方法中使用。</p>
</li>
<li><p><code>self.dataset = dataset</code>：将输入的 <code>dataset</code> 存储为对象属性，以便在模块的其他方法中使用。</p>
</li>
<li><p><code>self.project_scale = project_scale</code>：将输入的 <code>project_scale</code> 存储为对象属性，以便在模块的其他方法中使用。</p>
</li>
<li><p><code>def forward(self, x2d, projected_pix, fov_mask):</code>：前向传播方法，用于执行特征投影操作。接受三个输入参数：</p>
<ul>
<li><code>x2d</code>：2D 特征图，是一个张量，其形状为 <code>(c, h, w)</code>，其中 <code>c</code> 表示通道数，<code>h</code> 和 <code>w</code> 表示高度和宽度。</li>
<li><code>projected_pix</code>：包含 2D 像素坐标的张量，其形状为 <code>(bs, 2)</code>，其中 <code>bs</code> 表示批处理大小。</li>
<li><code>fov_mask</code>：表示感兴趣区域的遮罩，是一个布尔值张量，形状与 <code>projected_pix</code> 相同。</li>
</ul>
</li>
<li><p><code>c, h, w = x2d.shape</code>：获取输入 2D 特征图 <code>x2d</code> 的通道数、高度和宽度。</p>
</li>
<li><p><code>src = x2d.view(c, -1)</code>：将 2D 特征图 <code>x2d</code> 重新形状为 <code>(c, h * w)</code>，即将每个像素的特征连接到一个向量中。</p>
</li>
<li><p><code>zeros_vec = torch.zeros(c, 1).type_as(src)</code>：创建一个与 <code>src</code> 相同数据类型的零向量，用于在特征向量后添加一个零值，以匹配 3D 坐标。</p>
</li>
<li><p><code>src = torch.cat([src, zeros_vec], 1)</code>：将零向量添加到特征向量的末尾，以将特征向量的维度从 <code>(c, h * w)</code> 扩展到 <code>(c, h * w + 1)</code>。</p>
</li>
<li><p><code>pix_x, pix_y = projected_pix[:, 0], projected_pix[:, 1]</code>：从 <code>projected_pix</code> 中提取 2D 像素坐标的 x 和 y 值。</p>
</li>
<li><p><code>img_indices = pix_y * w + pix_x</code>：计算像素坐标对应的在扁平化 2D 特征图中的索引。</p>
</li>
<li><p><code>img_indices[~fov_mask] = h * w</code>：将不在感兴趣区域内的像素坐标对应的索引设置为 2D 特征图的最大索引值（类似于超出图像范围的像素索引）。</p>
</li>
<li><p><code>img_indices = img_indices.expand(c, -1).long()</code>：将计算得到的索引扩展为 <code>(c, h * w)</code> 的长整型张量。</p>
</li>
<li><p><code>src_feature = torch.gather(src, 1, img_indices)</code>：使用计算得到的索引从 <code>src</code> 中聚合出感兴趣的像素特征。</p>
</li>
<li><p><code>if self.dataset == &quot;NYU&quot;:</code>：如果数据集是 “NYU”，则执行以下操作。否则，执行 “kitti” 分支。</p>
<p>a. <code>x3d = src_feature.reshape(c, self.scene_size[0] // self.project_scale, self.scene_size[2] // self.project_scale, self.scene_size[1] // self.project_scale)</code>：将特征投影到 3D 空间，根据输入的 <code>scene_size</code> 和 <code>project_scale</code> 进行重新形状。这一步是根据 NYU 数据集的特定情况进行的形状转换。</p>
<p>b. <code>x3d = x3d.permute(0, 1, 3, 2)</code>：对投影得到的 3D 特征进行维度的置换。</p>
</li>
<li><p><code>elif self.dataset == &quot;kitti&quot;:</code>：如果数据集是 “kitti”，则执行以下操作。</p>
<p>a. <code>x3d = src_feature.reshape(c, self.scene_size[0] // self.project_scale, self.scene_size[1] // self.project_scale, self.scene_size[2] // self.project_scale)</code>：将特征投影到 3D 空间，根据输入的 <code>scene_size</code> 和 <code>project_scale</code> 进行重新形状。这一步是根据 kitti 数据集的特定情况进行的形状转换。</p>
</li>
<li><p><code>return x3d</code>：返回投影到 3D 空间的特征张量 <code>x3d</code>。</p>
</li>
</ol>
<p>这个模块的主要功能是将 2D 特征图中的像素特征投影到 3D 空间中，以便后续在 3D 空间中进行深度学习任务。具体的投影方法和维度变换取决于数据集的类型（”NYU” 或 “kitti”）和投影尺度（<code>project_scale</code>）。这个模块通常用于处理语义分割和深度估计等任务。</p>
<p>unet3d_kitti.py是一个3D U-Net模型的定义，用于语义分割任务。以下是代码的逐行解释：</p>
<ol>
<li><p><code>UNet3D</code> 类继承自 <code>nn.Module</code>，用于定义3D U-Net模型。</p>
</li>
<li><p><code>__init__</code> 函数用于初始化模型，它接受一些参数，如类别数 <code>class_num</code>、标准化层 <code>norm_layer</code>、全尺寸 <code>full_scene_size</code>、特征数 <code>feature</code>、项目尺度 <code>project_scale</code>、上下文先验 <code>context_prior</code> 和 Batch Normalization 层的动量 <code>bn_momentum</code>。</p>
</li>
<li><p><code>size_l1</code>、<code>size_l2</code> 和 <code>size_l3</code> 分别表示3D U-Net的3个不同尺寸层。</p>
</li>
<li><p><code>dilations</code> 是用于处理图像的卷积核的膨胀率。</p>
</li>
<li><p><code>self.process_l1</code> 和 <code>self.process_l2</code> 定义了两个处理层，用于处理输入3D数据，包括一系列的卷积、标准化和下采样操作。</p>
</li>
<li><p><code>self.up_13_l2</code>、<code>self.up_12_l1</code> 和 <code>self.up_l1_lfull</code> 定义了上采样层，将3D数据上采样到不同尺寸的层。</p>
</li>
<li><p><code>self.ssc_head</code> 定义了用于预测语义分割的头部，包括一系列卷积和输出层。</p>
</li>
<li><p><code>self.context_prior</code> 用于确定是否使用上下文先验。如果 <code>context_prior</code> 为真，将定义 <code>self.CP_mega_voxels</code>，它是上下文先验处理的一部分。</p>
</li>
<li><p><code>forward</code> 函数接受输入数据的字典 <code>input_dict</code>，包括 <code>x3d</code>，表示3D数据。</p>
</li>
<li><p>通过一系列处理步骤，如 <code>self.process_l1</code> 和 <code>self.process_l2</code>，输入数据被处理和下采样到不同尺寸层。</p>
</li>
<li><p>如果存在上下文先验，将使用 <code>self.CP_mega_voxels</code> 处理数据。</p>
</li>
<li><p>使用上采样层 <code>self.up_13_l2</code> 和 <code>self.up_12_l1</code> 将数据上采样到不同尺寸的层。</p>
</li>
<li><p>最终，通过 <code>self.ssc_head</code> 进行语义分割预测，并将结果存储在 <code>res</code> 字典中。</p>
</li>
</ol>
<p>这个模型的核心部分是3D U-Net结构，它包含编码器和解码器部分，用于从3D输入数据中提取特征并生成语义分割结果。根据输入数据的尺寸和具体任务，该模型可以适应不同的上下文先验处理。</p>
<h2 id="StereoScene"><a href="#StereoScene" class="headerlink" title="StereoScene"></a>StereoScene</h2><p>StereoScene用于3D语义场景补全（SSC），它充分利用了轻量级相机输入而无需使用任何外部3D传感器。研究者的关键想法是利用立体匹配来解决几何模糊性问题。为了提高其在不匹配区域的鲁棒性，论文引入了鸟瞰图（BEV）表示法，以激发具有丰富上下文信息的未知区域预测能力。在立体匹配和BEV表示法的基础上，论文精心设计了一个相互交互聚合（MIA）模块，以充分发挥两者的作用，促进它们互补聚合</p>
<p>代码链接：<a target="_blank" rel="noopener" href="https://github.com/Arlo0o/StereoScene">StereoScene: BEV-Assisted Stereo Matching Empowers 3D Semantic Scene Completion</a>, arXiv 2023.</p>
<p><img src="/pic/StereoScene.png"></p>
<p>整体的StereoScene框架如上图所示。论文遵循使用连续的2D和3 UNetsf作为backbones。给定输入的双目图像，我们使用2D UNet来提取多尺度特征。BEV潜在体积和立体几何体积分别由BEV构造器和立体构造器构造。为了充分利用这两个卷的互补潜力，提出了一个相互交互聚合模块来相互引导和聚合它们。</p>
<h3 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h3><p><a target="_blank" rel="noopener" href="https://github.com/Arlo0o/StereoScene/blob/main/projects/configs/occupancy/semantickitti/stereoscene.py">stereoscene.py</a>代码是一个配置文件，它定义了一个基于 MMDetection3D 的三维计算机视觉模型的配置。以下是代码中各部分的解释：</p>
<ol>
<li><p><code>_base_</code>：这是导入配置的基础文件的地方，<code>custom_nus-3d.py</code> 和 <code>default_runtime.py</code> 包含了一些共享的配置选项。这些基础配置文件通常包括数据集设置、运行时设置等。</p>
</li>
<li><p><code>plugin</code> 和 <code>plugin_dir</code>：这两个参数用于启用和指定 MMDetection3D 插件。插件是额外的功能模块，可以扩展 MMDetection3D 的功能。</p>
</li>
<li><p><code>img_norm_cfg</code>：这是图像归一化配置，指定了均值和标准差，以便对图像进行归一化。这通常用于图像预处理。</p>
</li>
<li><p><code>class_names</code>：定义了数据集中的类别名称。在这个例子中，有 20 个类别，包括车辆、行人、道路、建筑物等。</p>
</li>
<li><p><code>point_cloud_range</code>、<code>occ_size</code> 和 <code>lss_downsample</code>：这些参数定义了点云数据的范围、体素的大小和降采样率。它们是用于处理点云数据的重要参数。</p>
</li>
<li><p><code>model</code>：这是定义模型的部分。它指定了模型的各个组件，包括图像骨干网络、头部网络、点云处理头部等。这里使用的是 <code>BEVDepthOccupancy</code> 模型，该模型在三维计算机视觉中执行深度估计和语义分割任务。</p>
</li>
<li><p><code>dataset_type</code> 和 <code>data_root</code>：这些参数定义了数据集的类型和数据集的根目录。在这个例子中，使用的是 <code>CustomSemanticKITTILssDataset</code> 数据集，数据位于 <code>./data/occupancy/semanticKITTI/RGB/</code>。</p>
</li>
<li><p><code>train_pipeline</code> 和 <code>test_pipeline</code>：这些参数定义了数据预处理和增强的步骤。它们包括图像加载、语义分割标签加载、深度图生成等。</p>
</li>
<li><p><code>input_modality</code>：定义了输入的模态，包括激光雷达、相机、雷达、地图等。在这个例子中，仅使用相机数据。</p>
</li>
<li><p><code>test_config</code> 和 <code>data</code>：这些参数定义了训练和测试数据加载的配置，包括数据预处理、数据集类型、类别、点云范围等。</p>
</li>
<li><p><code>optimizer</code> 和 <code>optimizer_config</code>：这些参数定义了优化器的类型、学习率和权重衰减等配置。</p>
</li>
<li><p><code>lr_config</code>：定义了学习率调度策略，这里使用的是阶段性学习率下降。</p>
</li>
<li><p><code>checkpoint_config</code>：用于定义模型检查点的保存和保留策略。</p>
</li>
<li><p><code>runner</code>：指定了训练的运行方式，这里使用的是按照 epoch 训练。</p>
</li>
<li><p><code>evaluation</code>：定义了模型评估的配置，包括评估间隔和保存最佳模型的规则。</p>
</li>
</ol>
<p>这个配置文件的目的是定义了一个用于深度估计和语义分割的三维计算机视觉模型，并指定了数据加载和训练配置。模型的结构和数据集的具体细节在其他文件中定义。这个配置文件会被传递给 MMDetection3D 的训练和测试脚本，以实际执行训练和测试任务。</p>
<p>这个配置文件中定义了一个名为<code>model</code>的模型，其结构和配置包括以下几个主要组件：</p>
<ol>
<li><p><code>type</code>: 这里指定了模型的类型为<code>BEVDepthOccupancy</code>，这是一个自定义的三维计算机视觉模型，用于深度估计和语义分割任务。</p>
</li>
<li><p><code>img_backbone</code>: 定义了图像骨干网络的配置，该网络用于提取图像特征。在这个配置中，使用了<code>CustomEfficientNet</code>骨干网络，具体配置包括网络的类型、预训练模型的路径等。</p>
</li>
<li><p><code>img_neck</code>: 这部分定义了图像特征的“颈部”或附加处理，用于进一步处理骨干网络提取的特征。这里使用了<code>SECONDFPN</code>结构，对特征进行了上采样和融合。</p>
</li>
<li><p><code>img_view_transformer</code>: 这是一个自定义的视图变换器，用于将图像特征映射到点云视图，包括视角的转换和体素化。</p>
</li>
<li><p><code>img_bev_encoder_backbone</code> 和 <code>img_bev_encoder_neck</code>: 定义了用于处理点云的背景信息的网络。<code>img_bev_encoder_backbone</code>用于提取点云的背景特征，<code>img_bev_encoder_neck</code>用于进一步处理这些特征。</p>
</li>
<li><p><code>pts_bbox_head</code>: 这是点云处理头部的配置，用于执行深度估计和语义分割任务。它包括输出通道数、语义分割类别数、点云范围等配置。</p>
</li>
<li><p><code>train_cfg</code> 和 <code>test_cfg</code>: 分别定义了模型的训练和测试配置，这些配置包括损失函数、评价指标等。</p>
</li>
</ol>
<p>这个<code>model</code>定义了整个三维计算机视觉模型的结构，包括图像骨干网络、点云处理头部等组件。模型将通过这些组件来提取和处理图像和点云数据，以执行深度估计和语义分割任务。配置文件中还包括数据加载和训练策略等，用于训练和测试这个模型。</p>
<p>这个<code>model</code>配置是在使用MMDetection框架时的一种标准格式。MMDetection使用Python的字典格式来组织模型的配置。下面是对这个<code>model</code>配置的格式解释：</p>
<ol>
<li><p><code>type</code>: 这个字段指定了要使用的模型的类型。在这个配置中，<code>type</code>的值是<code>BEVDepthOccupancy</code>，表示要使用名为<code>BEVDepthOccupancy</code>的自定义模型。</p>
</li>
<li><p><code>img_backbone</code>, <code>img_neck</code>, <code>img_view_transformer</code>, <code>img_bev_encoder_backbone</code>, <code>img_bev_encoder_neck</code>, <code>pts_bbox_head</code>: 这些字段用于配置模型中不同组件的设置。每个组件的配置包含了该组件的类型、参数、超参数等。</p>
</li>
<li><p><code>train_cfg</code> 和 <code>test_cfg</code>: 这些字段定义了模型的训练和测试配置，包括损失函数、评价指标等。这些配置用于指导训练和测试过程。</p>
</li>
</ol>
<p>整个<code>model</code>配置是一个嵌套的字典，用于描述模型的结构和超参数设置。在MMDetection框架中，模型的配置采用了类似于YAML格式的字典结构，以便灵活配置不同的模型和任务。这种配置方式使得用户可以根据自己的需求轻松地定制和修改模型的设置。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Arlo0o/StereoScene/blob/main/projects/mmdet3d_plugin/occupancy/detectors/bevdepth_occupancy.py">bevdepth_occupancy.py</a>在上述代码中，<code>model</code> 的配置与类 <code>BEVDepthOccupancy</code> 相关，特别是与 <code>BEVDepthOccupancy</code> 类中的不同函数和组件有关。</p>
<p><code>BEVDepthOccupancy</code> 类是一个自定义的模型类，它继承自 <code>BEVDepth</code> 类。以下是与 <code>model</code> 配置中的组件相关的一些重要功能和配置项：</p>
<ol>
<li><p><code>image_encoder</code> 和 <code>bev_encoder</code> 函数：这些函数是模型的核心组件，分别用于处理图像信息和点云信息。<code>image_encoder</code> 用于处理输入的图像信息，而 <code>bev_encoder</code> 用于处理点云信息。这些函数将输入数据转换为特征表示。</p>
</li>
<li><p><code>forward_pts_train</code> 函数：这个函数在模型的训练过程中使用，计算了与点云相关的训练损失。这包括点云的目标检测和语义分割任务。</p>
</li>
<li><p><code>extract_img_feat</code> 函数：这个函数用于从输入的图像中提取特征。它将输入的图像分别送入 <code>image_encoder</code> 和 <code>img_view_transformer</code> 中，然后将它们的输出特征合并。</p>
</li>
<li><p><code>simple_test</code> 函数：这个函数用于在测试阶段生成模型的输出。它调用了 <code>extract_feat</code> 函数来提取特征，然后将这些特征传递给点云检测头部 <code>pts_bbox_head</code>，最后生成了测试结果。</p>
</li>
<li><p>其他与损失函数、数据预处理、评估等相关的函数：代码中还包括了与训练和测试相关的其他函数，用于处理损失函数的计算、数据的预处理以及评估模型性能等任务。</p>
</li>
</ol>
<p>总的来说，<code>model</code> 配置中的组件是 <code>BEVDepthOccupancy</code> 类中的一部分，用于定义模型的结构和训练&#x2F;测试过程中的操作。这些组件协同工作以实现点云目标检测和语义分割的任务。不同的组件负责处理不同类型的输入数据（图像、点云等）并生成相应的特征表示，最终用于模型的训练和测试。这种模块化的设计使得模型可以方便地扩展和配置，以适应不同的应用场景。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Arlo0o/StereoScene/blob/main/projects/mmdet3d_plugin/occupancy/dense_heads/occhead.py">occhead.py</a>这是一个名为<code>OccHead</code>的模型头，主要用于3D语义分割任务。以下是对该头部的关键要点：</p>
<ol>
<li><p><strong>输入和输出</strong>:</p>
<ul>
<li>输入：<code>OccHead</code>头部的输入包括体素特征（<code>voxel_feats</code>）以及点云信息（<code>points</code>）。</li>
<li>输出：它的输出通常有两部分，一部分是用于体素级别的语义分割（<code>output_voxels</code>），另一部分是用于点云级别的语义分割（<code>output_points</code>）。</li>
</ul>
</li>
<li><p><strong>监督方式</strong>:</p>
<ul>
<li>该头部支持两种不同级别的监督方式：体素级别和点云级别。</li>
<li>体素级别监督是指根据体素特征生成语义分割结果，用于离散的体素数据。</li>
<li>点云级别监督是指根据点云信息生成语义分割结果，用于稠密点云数据。</li>
</ul>
</li>
<li><p><strong>损失函数</strong>:</p>
<ul>
<li>对于体素级别监督，支持交叉熵（<code>voxel_ce</code>）、Lovasz-Softmax（<code>voxel_lovasz</code>）、Voxel Semantic Scaling（<code>voxel_sem_scal</code>）、Voxel Geometric Scaling（<code>voxel_geo_scal</code>）、IoU损失（<code>voxel_dice</code>）等损失函数。</li>
<li>对于点云级别监督，支持交叉熵（<code>point_ce</code>）和Lovasz-Softmax（<code>point_lovasz</code>）损失函数。</li>
</ul>
</li>
<li><p><strong>学习策略</strong>:</p>
<ul>
<li>对于体素级别监督，通过卷积操作生成语义分割结果。</li>
<li>对于点云级别监督，采样相关的体素特征和图像特征，然后使用多层感知机（Mlp）处理这些特征生成点云级别的语义分割结果。</li>
</ul>
</li>
<li><p><strong>语义Kitti</strong>:</p>
<ul>
<li>该模型头部支持语义Kitti数据集，并提供了相关的损失函数和度量指标。</li>
</ul>
</li>
<li><p><strong>损失权重</strong>:</p>
<ul>
<li>您可以设置不同损失函数的权重，以控制它们对最终损失的贡献。</li>
</ul>
</li>
<li><p><strong>可选功能</strong>:</p>
<ul>
<li>该模型头部支持不同的可选功能，如软权重（<code>soft_weights</code>）和图像特征采样（<code>sampling_img_feats</code>）。</li>
</ul>
</li>
<li><p><strong>其他</strong>:</p>
<ul>
<li>还包括一些图像处理操作，如上采样和网格采样。</li>
</ul>
</li>
</ol>
<p>总之，<code>OccHead</code>是一个用于语义分割任务的多功能头部，支持体素级别和点云级别的监督，提供了多种损失函数和度量指标以用于不同的数据集和任务。这些选择和配置可以根据具体的任务需求进行调整和优化。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">oceanechy</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://oceanechy.github.io/markdown_12_4/markdown/code_SSC.html">http://oceanechy.github.io/markdown_12_4/markdown/code_SSC.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">oceanechy</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/markdown_12_4/markdown/code_SSC.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-12-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            oceanechy
                            
                        </span>
                    </div>
                </div>

                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="far fa-dot-circle"></i>
            </div>
            <div class="card">
                <a href="/markdown_12_4/markdown/code_SSC.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-12-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            oceanechy
                            
                        </span>
                    </div>
                </div>

                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">oceanechy</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">140.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/oceanechy" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1945942166@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1945942166" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1945942166" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/xiao-hai-38-6-81" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/xiao-hai-38-6-81" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
